## 题目分析
题目要求计算最合适的各组BMI区间，使得NIPT的时机最合适，且风险最小、测量误差最小。因而我们需要在每位孕妇所有NIPT样本中首次y染色体浓度>=4%且数据得当的相关数据，以判别MBI同孕周的关联，并探讨原始读段数、唯一比对的读段数、被过滤掉读段数的比例、重复读段的比例、在参考基因组上比对的比例对y染色体浓度的影响。  

## 数据预处理
从...中抽取各孕妇样本中首次y染色体浓度>=4%且abs(原始读段数 * （1 - 被过滤掉读段数的比例）* 在参考基因组上比对的比例 *（1 - 重复读段的比例）- 唯一比对的读段数) < 2就把这一组数据剔除的相关数据共159行。  

## 建模过程

### 1. 聚类分析
采用DBSCAN+局部加权回归的方案。

1.1 DBSCAN
鉴于传统K-means算法对噪声敏感且无法自动识别簇数量的缺陷，本研究采用基于密度的空间聚类算法（DBSCAN）对数据进行聚类分析。该算法基于“簇是数据空间中密集区域”的假设，能够识别任意形状的簇并有效分离噪声点。  
**同时考虑到有|Z| >= 3的异常点要处理，我们在对应的点增加了权重使模型趋向于绕开异常点以降低其于数据中的浓度，可使求解结果风险尽量小。**  

#### 数学模型定义
- ε-邻域： 对于给定对象 $p$，其 $ε$-邻域定义为以 $p$ 为中心、以 $ε$ 为半径的圆形区域内的对象集合，记为 $N_ε(p) = \{q ; | ; \text{dist}(p, q) ≤ ε\}$。
- 核心对象： 如果对象 $p$ 的 $ε$-邻域内至少包含 $MinPts$ 个对象（包括$p$本身），即 $|N_ε(p)| ≥ MinPts$，则称 $p$ 为核心对象。
- 直接密度可达： 如果对象 $p$ 在 $q$ 的 $ε$-邻域内，且 $q$ 是一个核心对象，则称对象 $p$ 是从 $q$ 直接密度可达的。
- 密度可达： 如果存在一个对象链 $p_1, p_2, ..., p_n$，其中 $p_1 = q$, $p_n = p$，且对于 $p_{i+1}$ 是从 $p_i$ 直接密度可达的，则称 $p$ 是从 $q$ 密度可达的。
- 密度相连： 如果存在一个对象 $o$，使得对象 $p$ 和 $q$ 都是从 $o$ 密度可达的，则称 $p$ 和 $q$ 是密度相连的。  
#### 算法聚类过程
- 先对数据进行标准化
- 算法遍历所有未访问的点。
- 如果一个点 $p$ 是核心对象，则以其为基础创建一个新的簇，并迭代地收集所有从该点密度可达的对象，形成一个簇。
- 如果一个点不是核心对象，且不属于任何簇，则将其标记为噪声（或边界点）。
参数选择： 参数 $ε$ 和 $MinPts$ 通过绘制 **k-distance图（已绘制）** 并结合问题背景进行确定.在 DBSCAN 聚类算法中，两个核心参数是邻域半径 ϵ 和最小点数 k = MinPts。我们首先根据经验法则，将 k 设定为**3到10的整数**，并多次生成最佳半径（ϵ 值），以确保结果上聚类只在密度高的区域形成。在该图中，k 被设定为 min_pts，图中的**拐点（即二阶差分，“曲率”最大的点）**所对应的距离即为最优 ϵ。

**注意**  
很遗憾，我们的各种参数的聚类中都只举出一类来。虽然这侧面反映了数据极大可能也只有一个类别，但我们仍旧打算使用HDBSCAN再进行一次校验。  
HDBSCAN正是为了解决这个问题而生。它不是直接基于密度的，而是基于密度的层次结构。步骤如下：   
- 构建最小生成树 (Minimum Spanning Tree, MST)：首先，算法计算每对数据点之间的距离，然后使用这些距离构建一个加权的完全图。接着，它从中提取出最小生成树。在这个树中，每条边的权重就是它所连接的两个点的距离。
- 构建密度感知的 MST (Density-Aware MST)：为了将密度信息融入到树结构中，HDBSCAN 引入了一个新的距离概念——核心距离 (Core Distance)。一个点的核心距离是它到其第 MinPts 个最近邻的距离。然后，算法用这个核心距离来定义 相互可达性距离 (Mutual Reachability Distance)：`mrd(a,b)=max(core−dist(a),core−dist(b),dist(a,b))`，这个距离确保了只有当两个点都位于各自的“核心”区域时，它们才被认为是紧密相连的。HDBSCAN 接着用这些相互可达性距离来重新构建最小生成树。  
- 构建层次聚类树 (Hierarchy of Clusters)：基于密度感知的 MST，HDBSCAN 通过逐渐“切断”相互可达性距离最大的边来构建一个层次聚类树。这个过程类似于一个反向的 Kruskal 算法。当边被移除时，剩下的连通分量形成了一个新的簇。这个层次结构可以看作是不同密度水平下簇的演变过程。
- 提取扁平化簇 (Extracting Flat Clusters)：这是 HDBSCAN 最关键的一步。它不直接从层次树的某一层切分出簇，而是通过分析每个簇的稳定性 (Stability) 来选择最有代表性的簇。一个簇的稳定性衡量了它在层次结构中持续存在的时间（即从其形成到与另一个簇合并或消散的“生命周期”）。稳定性更高的簇被认为是更可靠的聚类结果。  
但是结果发现具有两个簇（**已绘制**），因而我们使用hdbscan的结果修正dbscan的:注意到hdbscan有一主簇，对多参数的端点求均值可得...这里的最优周数由图上回归曲线的最小点的y值（见下节）表征。  

1.2 局部加权回归（**已绘制**）
由预处理数据散点图可知，散点分别聚集在多个区间，因而采用该方法最合适。  

#### 局部加权回归 (LOESS) 在二维数据中的特点：
- 优点：
在每个预测点用邻域数据拟合局部低阶多项式，非常适合处理“局部有聚集”的情况。  
不需要假设全局函数形式，能够拟合复杂、非均匀的曲面。  
灵活捕捉局部变化（比如数据云团、簇状分布）。  
- 缺点：
计算量大：二维局部拟合比一维更耗时。  
边界区域或数据稀疏区域，拟合结果不稳定。  
参数选择（邻域半径、权重函数）对结果敏感。  
不会产生全局解析模型，解释性差。  

#### 核心思想和描述
Loess 的核心思想是** 局部拟合 **。它在每个预测点上，都用一个独立的加权线性回归或加权二次回归来拟合该点附近的局部数据。
你可以这样描述它的基本原理：
> “局部加权回归（Loess）是一种强大的非参数回归方法，它不依赖于任何预设的函数形式来描述变量之间的关系。其核心思想是，在数据空间中，每个预测点 $x_i$ 的拟合值 $\hat{y}_i$ 仅由其附近的局部数据点决定。
> **该方法通过为每个局部数据点赋予不同的权重来完成拟合：** 距离预测点 $x_i$ 越近的数据点，其权重越高；距离越远，权重越低。通过这种方式，Loess 能够灵活地捕捉数据的非线性趋势和局部变化，生成一条平滑的拟合曲线。”  

#### 数学方程
虽然没有单一的全局方程，但 Loess 的局部拟合过程可以用数学形式来描述。对于每一个预测点 $x$，Loess 的拟合值 $\hat{y}$ 是通过解决以下加权最小二乘问题得到的：
$$\hat{y}(x) = \arg\min_{\beta_0, \beta_1} \sum_{i=1}^{n} w_i(x) \cdot (y_i - (\beta_0 + \beta_1 x_i))^2$$
其中：
* $n$ 是数据点的总数。
* $(x_i, y_i)$ 是原始数据点。
* $(\beta_0, \beta_1)$ 是**局部**线性回归的系数。
* $w_i(x)$ 是**权重函数**，它取决于数据点 $x_i$ 与预测点 $x$ 之间的距离。常用的权重函数是**三次权重函数（Tricube Weight Function）**，其定义为：
$$w(d) = \begin{cases} (1 - d^3)^3 & \text{if } d < 1 \\ 0 & \text{if } d \ge 1 \end{cases}$$
这里的 $d$ 是数据点 $x_i$ 到预测点 $x$ 的标准化距离。  

### 2. 误差分析
由于y染色体浓度遵循一个类双峰分布，难以描述且“原始读段数,唯一比对的读段数,被过滤掉读段数的比例,重复读段的比例,在参考基因组上比对的比例”五个影响观测值的指标互相具有关联性：`原始读段数*（1-被过滤掉读段数的比例）*在参考基因组上比对的比例*（1-重复读段的比例）约等于唯一比对的读段数`，我们决定使用主成分回归方法。  

#### 模型思路
主成分回归 (Principal Component Regression, PCR)  
为什么推荐：先PCA降维自变量（处理共线性），再回归。数学上PCA有明确特征分解，回归系数易追溯回原变量。  
数学描述：PCA将X分解：  
$  X = U \Sigma V^T  $  
取前k个主成分 (PCs) 作为新X' = U_k \Sigma_k，然后线性回归：  
$  Y = \beta_0 + \beta' X' + \epsilon  $  
追溯系数：原 β = V_k \beta'（解释每个X_i 在PCs中的权重 v_{i,j}，e.g., “重复比例在PC1中权重0.4，PC1解释Y的30%”）。  
适用性：您的分布图显示自变量可能低秩（因公式相关），PCA可压缩到2-3维。Julia用MultivariateStats.jl的pca()。  

#### 论文表述
1. 选择主成分回归的理由
在论文中，首先你需要解释为什么要选择 PCR 而不是标准的多元线性回归（MLR）。  
问题提出: 提及5个误差指标（原始读段数、唯一比对的读段数等）之间存在显著的多重共线性。  
论证: 引用你最初的发现，即原始读段数 * (1 - 被过滤掉读段数的比例) * 在参考基因组上比对的比例 * (1 - 重复读段的比例) ≈ 唯一比对的读段数。这个近似关系就是共线性的直接证据。  
结论: 解释说多重共线性会导致传统 MLR 的回归系数不稳定、难以解释。因此，引入 PCR 是一种更稳健的替代方案，它能将共线性变量转换为一组正交（不相关）的主成分，从而消除这一问题。  
2. 主成分分析（PCA）结果的描述
这是你展示5个自变量之间关系的核心部分。  
主成分的贡献: 描述你选择的3个主成分（PC1、PC2、PC3）分别解释了原始数据方差的多少百分比。例如，"我们提取了3个主成分，它们总共解释了方差的85%（举例数值），因此可以有效代表原始数据集中的大部分信息。"  
主成分的构成: 接下来，你需要明确阐述每个主成分是由哪些原始变量构成的，以及各自的权重（即loadings）。你可以用一个表格来展示这个关系。  
例如，你可以写道："PC1主要由'原始读段数'和'唯一比对的读段数'构成，这反映了这两个变量在数据集中具有高度相关性。"  
注意: 这里的权重（即 loadings）是你代码中 loadings 矩阵的值。它们的符号（正负）和大小很重要，能直接说明变量之间的关系。  
3. 主成分回归结果的分析与影响量化
这是最关键的部分，它直接回答了每个变量对 Y 染色体浓度的影响。  
回归模型的建立: 简要说明你用选定的3个主成分作为自变量，Y 染色体浓度作为因变量，建立了线性回归模型。  
影响系数的解释: 这是最难但最重要的部分。你需要将模型中的主成分回归系数，通过投影，转换为原始变量的回归系数。  
量化影响: 直接展示你计算出的原始变量的系数（pcr_coeffs_orig）。你可以用一个表格来呈现这些结果。  
| 变量名称 | 回归系数 |
| :--- | :---: |
| 原始读段数 | pcr_coeffs_orig[1] |
| 唯一比对的读段数 | pcr_coeffs_orig[2] |
| ... | ... |
结果阐述: 根据系数的符号和大小，量化每个变量的影响。  
例如，"我们发现'重复读段的比例'的系数为正，表明该比例每增加一个标准单位，Y染色体浓度将平均增加 pcr_coeffs_orig[4] 个标准单位。这说明较高的重复读段比例与更高的Y染色体浓度相关。"  
警告: 你应该强调这些结果是在考虑了共线性影响后得出的，因此比传统的 MLR 结果更可靠。  